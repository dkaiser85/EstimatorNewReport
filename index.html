<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Culture MRI® Profit Estimator</title>
    <!-- Import Inter Font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- Viewport Meta Tag -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/png" sizes="192x192" href="./icons/CMRI192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./icons/CMRI512.png">
    <link rel="apple-touch-icon" href="./icons/CMRI192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="./icons/CMRI192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="./icons/CMRI512.png">
    <style>
        /* Add/modify these styles */
        html, body {
            max-width: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: transparent;
            padding: 10px;
            box-sizing: border-box;
            width: 100%;
            display: flex;
            justify-content: center;
        }

        /* Container Styling */
        .calculator-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            padding: 25px;
            border-radius: 10px;
            background-color: transparent;
            box-shadow: none;
            box-sizing: border-box;
        }

        /* Header Styling */
        .calculator-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .calculator-header h2 {
            font-size: 28px;
            font-weight: 700; /* Inter Bold */
            color: #333333;
            margin-bottom: 5px;
        }

        .calculator-header p {
            font-size: 16px;
            font-weight: 300; /* Inter Light */
            color: #6B7D8D;
            margin: 0;
        }

        /* Input Section */
        .input-section {
            margin-bottom: 25px;
        }

        .input-group {
            margin-bottom: 25px;
            padding: 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 300; /* Inter Light */
            color: #6B7D8D;
        }

        /* Normal input styling (unchanged) */
        .input-group input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            font-weight: 400;
            border: 1px solid #d3d3d3;
            border-radius: 6px;
            outline: none;
            box-sizing: border-box;
        }

        /* Only applies at 320px or smaller */
        @media (max-width: 320px) {
            .input-group input {
                font-size: 12px;
            }

            .input-group input::placeholder {
                font-size: 12px;
            }
        }

        /* Results Section */
        .results-section {
            margin-top: 25px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .result-item {
            width: 48%;
            margin-bottom: 25px;
            text-align: center;
        }

        .result-item h3 {
            font-size: 18px;
            font-weight: 300; /* Inter Light */
            color: #6B7D8D;
            margin-bottom: 10px;
        }

        /* Gauge Styling */
        .gauge {
            width: 195px;
            height: 195px;
            position: relative;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .gauge__background {
            stroke: #EFEFEF;
            stroke-width: 10;
            fill: none;
        }

        .gauge__fill {
            stroke-linecap: round;
            stroke-width: 10;
            fill: none;
            transition: stroke-dashoffset 1s ease-out, stroke 0.5s ease;
        }

        /* Financial Metrics */
        .financial-metrics {
            width: 100%;
            margin-top: 20px;
        }

        .financial-item {
            margin-bottom: 15px;
            text-align: center;
        }

        .financial-item h3 {
            font-size: 18px;
            font-weight: 300;
            color: #6B7D8D;
            margin-bottom: 5px;
        }

        .financial-item p {
            font-size: 20px;
            font-weight: 700;
            color: #173248;
            margin: 0;
            transition: color 0.3s ease;
        }

        .financial-item p.red {
            color: #ED5C5C;
        }

        .financial-item p.green {
            color: #75BB7D;
        }

        .financial-item p.black {
            color: #000000; /* New class for black color */
        }

        /* Footer Styling */
        .calculator-footer {
            text-align: center;
            margin-top: 25px;
            font-size: 14px;
            color: #777777;
        }

        /* Liner Note Styling */
        .liner-note {
            text-align: center;
            margin-top: 15px;
            font-size: 12px;
            color: #6B7D8D;
            font-weight: 300;
        }

        .liner-note .footnote {
            margin-top: 10px; /* Adjust the value as needed */
            display: block;
        }

        /* Responsive Design */
        @media (max-width: 600px) {
            .result-item {
                width: 100%;
            }

            .gauge {
                width: 250px;
                height: 250px;
            }

            .gauge svg {
                width: 250px;
                height: 250px;
            }

            .gauge text {
                font-size: 40px;
            }

            .financial-item p {
                font-size: 18px;
            }

            /* Added responsive styles for financial-metrics-center */
            .financial-metrics-center {
                flex-direction: column; /* Stacks items vertically on small screens */
            }

            .financial-metrics-center h3.total-additional-profit,
            .financial-metrics-center p.black {
                margin-right: 0; /* Removes right margin when stacked */
            }

            body {
                padding: 10px;
            }
            
            .calculator-container {
                padding: 15px;
                width: 100%;
            }

            .input-group {
                padding: 0;
            }

            .result-item h3 {
                text-align: center; /* Center the titles */
                padding-right: 35px; /* Make room for info icon */
                padding-left: 35px; /* Balance the padding */
                position: relative; /* For absolute positioning of info icon */
            }

            .result-item .info-icon {
                position: absolute;
                right: 5px;
                top: 50%;
                transform: translateY(-50%);
            }
        }

        .logo-container {
            text-align: center;
            margin-top: 20px;  /* Add space above the logo */
        }

        .logo {
            max-width: 250px;  /* Adjust this value to control logo size */
            height: auto;
            display: inline-block;
        }

        /* Responsive styling for the logo */
        @media (max-width: 600px) {
            .logo {
                max-width: 250px;  /* Even smaller on mobile */
            }
        }

        /* Add these new styles */
        .info-icon {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 24px;
            height: 24px;
            background-color: transparent;
            color: #6666CC;
            border: 1px solid #6666CC;
            border-radius: 50%;
            font-size: 12px;
            margin-left: 10px;
            cursor: pointer;
            position: relative;
            font-style: italic;
            vertical-align: middle;
            z-index: 100;
            -webkit-tap-highlight-color: transparent;
            line-height: 1;
            pointer-events: auto;
        }

        .info-icon:hover {
            background-color: #6666CC;
            color: white;
        }

        .tooltip {
            visibility: hidden;
            position: absolute;
            bottom: calc(100% + 10px); /* Add some space between icon and tooltip */
            left: 0;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 12px;
            border-radius: 4px;
            font-size: 14px;
            width: 250px;
            text-align: left;
            z-index: 1000; /* Ensure it's above other elements */
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none; /* Prevents tooltip from interfering with clicks */
        }

        .info-icon:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        /* Add arrow to tooltip */
        .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        /* Add these styles to your existing CSS */
        .error-message {
            color: #ED5C5C;
            font-size: 14px;
            margin-top: 5px;
            font-weight: 400;
        }

        .input-group input:invalid {
            border-color: #ED5C5C;
        }

        /* Optional: Add a transition for smoother error state changes */
        .input-group input {
            transition: border-color 0.3s ease;
        }

        /* Add these animation styles */
        @keyframes numberChange {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Add animation class */
        .animate-number {
            animation: numberChange 0.5s ease-out;
        }

        /* Update these mobile-specific styles */
        @media (max-width: 768px) {
            /* Remove the fixed positioning */
            html {
                overflow-x: hidden; /* Only prevent horizontal scroll */
                width: 100%;
                height: 100%;
            }
            
            body {
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                width: 100%;
                min-height: 100%;
                position: relative; /* Change from absolute to relative */
                margin: 0;
                padding: 10px;
                box-sizing: border-box;
                display: flex;
                justify-content: center;
            }
            
            /* Improve touch targets */
            .input-group input,
            button {
                min-height: 44px;
            }
            
            .input-group {
                margin-bottom: 20px;
            }
            
            input, button {
                font-size: 16px;
            }

            /* Ensure info icons are clickable */
            .info-icon {
                z-index: 1; /* Add this to ensure icons are clickable */
            }

            /* Ensure tooltips appear above other elements */
            .tooltip {
                z-index: 2;
            }

            .tooltip {
                width: 200px;
                left: 0;
                transform: translateX(-50%);
            }

            /* Ensure tooltips don't go off-screen on the right */
            .info-icon:last-child .tooltip {
                left: auto;
                right: 0;
                transform: translateX(0);
            }

            /* Adjust position for right-aligned tooltips */
            .info-icon:last-child .tooltip::after {
                left: auto;
                right: 10px;
            }

            h3 {
                position: relative;
                padding-right: 25px; /* Make room for info icon */
            }
        }

        /* Add install banner styles */
        .install-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px;
            background: #6666CC;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            display: none; /* Hidden by default */
        }

        .install-banner.show {
            display: flex;
        }

        /* Add styles for the label wrapper */
        .input-label-wrapper {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            pointer-events: none;
        }

        .input-label-wrapper label {
            pointer-events: auto;
            margin: 0;
            padding: 0;
            line-height: normal;
        }

        .input-label-wrapper .info-icon {
            pointer-events: auto;
        }

        /* Add specific styles for the Total Labor Spend label */
        #totalLaborCost-label {
            display: flex;
            align-items: center;
            gap: 5px; /* Adds consistent spacing between label and icon */
        }

        /* Add/modify these styles */
        @media (max-width: 600px) {
            .financial-item h3 {
                text-align: center; /* Center the titles */
                padding-right: 35px; /* Increase padding to accommodate the info icon */
                padding-left: 35px; /* Add left padding for balance */
                position: relative; /* For absolute positioning of info icon */
            }

            .financial-item .info-icon {
                position: absolute;
                right: 5px;
                top: 50%;
                transform: translateY(-50%);
            }
        }

        .share-section {
            text-align: center;
            margin: 20px 0;
        }

        .share-button {
            background-color: #6666CC;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .share-button:hover {
            background-color: #5555BB;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            border-radius: 10px;
        }

        .close-modal {
            position: absolute;
            right: 20px;
            top: 10px;
            font-size: 24px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #6B7D8D;
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #d3d3d3;
            border-radius: 4px;
        }

        .share-options {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .share-options button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .share-submit {
            background-color: #6666CC;
            color: white;
        }

        .download-pdf {
            background-color: #f0f0f0;
            color: #333;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
            padding: 0 20px;
        }

        .action-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 160px;
        }

        .button-icon {
            transition: transform 0.2s ease;
        }

        .share-button {
            background-color: #6666CC;
            color: white;
        }

        .share-button:hover {
            background-color: #5555BB;
        }

        .share-button:hover .button-icon {
            transform: translateY(-1px);
        }

        .reset-button {
            background-color: #f0f0f0;
            color: #444;
        }

        .reset-button:hover {
            background-color: #e4e4e4;
        }

        .reset-button:hover .button-icon {
            transform: rotate(45deg);
        }

        /* Mobile optimization */
        @media (max-width: 600px) {
            .action-buttons {
                flex-direction: column;
                gap: 10px;
                margin: 20px 0;
            }

            .action-button {
                width: 100%;
                padding: 14px 20px;
            }
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .secondary-button {
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
        }

        .secondary-button:hover {
            background-color: #e4e4e4;
        }

        .primary-button {
            background-color: #6666CC;
            color: white;
            border: none;
        }

        .primary-button:hover {
            background-color: #5555BB;
        }

        .benefits-list {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .benefits-list p {
            color: #666;
            margin: 0 0 12px 0;
            font-weight: 500;
        }

        .benefits-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .benefits-list li {
            color: #333;
            padding: 8px 0;
            font-size: 15px;
        }

    </style>
</head>
<body>

<div class="calculator-container" role="main">
    <div class="calculator-header" role="banner">
        <h2>The Culture MRI® Calculator</h2>
        <p>See How Engagement and Turnover Impact Your Bottom Line</p>
    </div>

    <div class="input-section" role="form" aria-label="Calculator Inputs">
        <!-- Total Labor Spend Input -->
        <div class="input-group">
            <div class="input-label-wrapper">
                <label for="totalLaborCost">Total Labor Spend (USD)</label>
                <span class="info-icon" role="tooltip" tabindex="0" aria-label="Information about Total Labor Spend">i
                    <span class="tooltip" role="tooltip">The total amount spent annually on employee salaries, wages, and benefits.</span>
                </span>
            </div>
            <input type="text" 
                   id="totalLaborCost" 
                   placeholder="Enter your total labor spend in US dollars"
                   aria-label="Total Labor Spend in USD">
        </div>

        <!-- Estimated Employee Engagement Input -->
        <div class="input-group">
            <label for="employeeEngagement">
                Estimated Employee Engagement (%)
                <span class="info-icon">i
                    <span class="tooltip">2024 US employee engagement (Gallup): USA: 33%, Worldwide: 23%, Best Practice Orgs: 70% </span>
                </span>
            </label>
            <input type="number" id="employeeEngagement" placeholder="Enter estimated employee engagement" min="0" max="100">
        </div>

        <!-- Projected Turnover Percentage Input -->
        <div class="input-group">
            <label for="turnoverPercentage">
                Projected Turnover Percentage (%)
                <span class="info-icon">i
                    <span class="tooltip">Current total estimated percentage of employees.</span>
                </span>
            </label>
            <input type="number" id="turnoverPercentage" placeholder="Enter projected turnover percentage" min="0" max="100">
        </div>
    </div>

    <div class="results-section">
        <!-- Overall Engagement Gauge -->
        <div class="result-item">
            <h3>
                Overall Engagement
                <span class="info-icon">i
                    <span class="tooltip">Estimate of how well employees can excel. Represents how much they feel supported, valued and aligned with the organization’s goals and objectives.</span>
                </span>
            </h3>
            <div class="gauge">
                <svg width="195" height="195" viewBox="0 0 195 195">
                    <!-- Background Arc -->
                    <path class="gauge__background" d="M39 162.5 A78 78 0 1 1 156 162.5" />
                    <!-- Fill Arc -->
                    <path class="gauge__fill" id="engagementFill" d="M39 162.5 A78 78 0 1 1 156 162.5"
                          stroke="#ED5C5C" stroke-dasharray="367.566" stroke-dashoffset="367.566" />
                    <!-- Percentage Text -->
                    <text x="97.5" y="115" text-anchor="middle" font-size="31px" font-weight="700"
                          fill="#173248" id="engagementText">0%</text>
                </svg>
            </div>
        </div>

        <!-- Return-On-Labor® Gauge -->
        <div class="result-item">
            <h3>
                Return-On-Labor®
                <span class="info-icon">i
                    <span class="tooltip">The financial efficiency of labor, based on employee engagement and ability to contribute to expected business outcomes.</span>
                </span>
            </h3>
            <div class="gauge">
                <svg width="195" height="195" viewBox="0 0 195 195">
                    <!-- Background Arc -->
                    <path class="gauge__background" d="M39 162.5 A78 78 0 1 1 156 162.5" />
                    <!-- Fill Arc -->
                    <path class="gauge__fill" id="returnOnLaborFill" d="M39 162.5 A78 78 0 1 1 156 162.5"
                          stroke="#E1D687" stroke-dasharray="367.566" stroke-dashoffset="367.566" />
                    <!-- Percentage Text -->
                    <text x="97.5" y="115" text-anchor="middle" font-size="31px" font-weight="700"
                          fill="#173248" id="returnOnLaborText">0%</text>
                </svg>
            </div>
        </div>
    </div>

    <div class="financial-metrics">
        <!-- A 1% Engagement Shift in Engagement is worth -->
        <div class="financial-item">
            <h3>
                A 1% Shift in Engagement is worth
                <span class="info-icon">i
                    <span class="tooltip">Financial impact of increasing engagement by 1%.</span>
                </span>
            </h3>
            <p class="green" id="onePercentChange">--</p>
        </div>

        <!-- Annualized Lost Labor -->
        <div class="financial-item">
            <h3>
                Annualized Lost Labor
                <span class="info-icon">i
                    <span class="tooltip">Cost of underutilized employee potential (the gap between employee contributions and the labor investment).</span>
                </span>
            </h3>
            <p class="red" id="lostLaborCost">--</p>
        </div>

        <!-- Annualized Total Losses with Turnover -->
        <div class="financial-item">
            <h3>
                Annualized Total Losses with Turnover
                <span class="info-icon">i
                    <span class="tooltip">Total annual cost of lost productivity from disengagement and turnover.</span>
                </span>
            </h3>
            <p class="red" id="totalAnnualizedLosses">--</p>
        </div>
    </div>

    <div class="action-buttons">
        <button id="downloadResultsBtn" class="action-button primary-button">
            <svg class="button-icon" viewBox="0 0 24 24" width="18" height="18">
                <path fill="currentColor" d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
            </svg>
            Save & Download Results
        </button>
        <button id="resetButton" class="action-button reset-button">
            <svg class="button-icon" viewBox="0 0 24 24" width="18" height="18">
                <path fill="currentColor" d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
            </svg>
            Reset Calculator
        </button>
    </div>

    <div class="logo-container">
        <img src="https://static.showit.co/file/JNQ0xT5W_YRPIk_uSDJ7-Q/176740/3.png" alt="Company Logo" class="logo">
    </div>

    <div class="calculator-footer">
        <p>&copy; 2024 The Culture MRI®. All Rights Reserved.</p>
    </div>

    <div class="liner-note">
        <em>*For simplicity, headcount is estimated using national average salary figures.</em>
    </div>
</div>

<div id="resultsModal" class="modal">
    <div class="modal-content results-modal">
        <span class="close-modal">&times;</span>
        <h3>Get Your Complete Analysis</h3>
        
        <form id="resultsForm">
            <div class="form-group">
                <label for="name">Name *</label>
                <input type="text" id="name" required>
            </div>
            <div class="form-group">
                <label for="company">Company *</label>
                <input type="text" id="company" required>
            </div>
            <div class="form-group">
                <label for="email">Email *</label>
                <input type="email" id="email" required>
            </div>
            <div class="modal-buttons">
                <button type="button" class="action-button secondary-button" id="downloadPdfBtn">
                    Download PDF Report
                </button>
                <button type="button" class="action-button primary-button" id="emailResultsBtn">
                    Email Results to Me
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const params = new URLSearchParams(window.location.search)
        const ref = params.get('ref') ?? ''

        const inputLaborCost = document.getElementById('totalLaborCost');
        const inputEngagement = document.getElementById('employeeEngagement');
        const inputTurnover = document.getElementById('turnoverPercentage');

        const engagementFill = document.getElementById('engagementFill');
        const engagementText = document.getElementById('engagementText');

        const returnOnLaborFill = document.getElementById('returnOnLaborFill');
        const returnOnLaborText = document.getElementById('returnOnLaborText');

        const lostLaborCostEl = document.getElementById('lostLaborCost');
        const onePercentChangeEl = document.getElementById('onePercentChange');
        const totalAnnualizedLossesEl = document.getElementById('totalAnnualizedLosses');

        const resetButton = document.getElementById('resetButton');
        resetButton.addEventListener('click', function() {
            // Clear all input fields
            inputLaborCost.value = '';
            inputEngagement.value = '';
            inputTurnover.value = '';
            
            // Reset all calculations and displays
            resetGauges();
        });

        // Initialize gauges and displays
        calculateMetrics();

        // Add event listeners for input fields
        inputLaborCost.addEventListener('input', function(e) {
            // Remove any existing '$', commas, and non-digits except decimal point
            let value = e.target.value.replace(/[$,]/g, '').replace(/[^\d.]/g, '');
            
            // If there's a value, format it
            if (value) {
                // Format with commas and add dollar sign
                e.target.value = '$' + formatNumberWithCommas(value);
            } else {
                // If empty, don't add the dollar sign
                e.target.value = '';
            }
            calculateMetrics();
        });

        // Add validation function
        function validatePercentageInput(input) {
            const value = parseFloat(input.value);
            const inputGroup = input.closest('.input-group');
            
            // Clear any existing error messages
            const existingError = inputGroup.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }
            
            // Validate the input
            if (isNaN(value) || value < 0 || value > 100) {
                input.setCustomValidity('Please enter a value between 0 and 100');
                input.reportValidity();
                
                // Add error message below input
                const errorMessage = document.createElement('div');
                errorMessage.className = 'error-message';
                errorMessage.textContent = 'Please enter a value between 0 and 100';
                inputGroup.appendChild(errorMessage);
                
                return false;
            }
            
            input.setCustomValidity('');
            return true;
        }

        // Update the event listeners
        inputEngagement.addEventListener('input', function() {
            if (validatePercentageInput(this)) {
                calculateMetrics();
            }
        });

        inputTurnover.addEventListener('input', function() {
            if (validatePercentageInput(this)) {
                calculateMetrics();
            }
        });

        function formatNumberWithCommas(number) {
            if (!number) return '';
            const parts = number.toString().split(".");
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return parts.join(".");
        }

        function updateGauge(fillElement, percentage, color) {
            // Ensure percentage does not exceed 100%
            const cappedPercentage = Math.min(Math.max(percentage, 0), 100);
            const dashArray = 367.566; // For radius 78
            const dashOffset = dashArray - (cappedPercentage / 100) * dashArray;

            fillElement.style.strokeDasharray = dashArray;
            fillElement.style.strokeDashoffset = dashOffset;
            fillElement.style.stroke = color;
        }

        function calculateMetrics() {
            // Parse the labor cost input by removing '$' and commas
            const laborCost = parseFloat(inputLaborCost.value.replace(/[$,]/g, ''));
            const engagementPercentage = parseFloat(inputEngagement.value);
            const turnoverPercentage = parseFloat(inputTurnover.value);

            // Constants
            const averageSalary = 60000; // Assumed average salary
            const costToReplaceOneEmployee = 9861; // Given average replacement cost

            if (
                isNaN(laborCost) || laborCost <= 0 ||
                isNaN(engagementPercentage) || engagementPercentage < 0 || engagementPercentage > 100 ||
                isNaN(turnoverPercentage) || turnoverPercentage < 0 || turnoverPercentage > 100
            ) {
                resetGauges();
                return;
            }

            /*** Update Overall Engagement Gauge ***/
            let engagementColor = '';

            if (engagementPercentage <= 50) {
                engagementColor = '#ED5C5C'; // Red
            } else if (engagementPercentage <= 84) {
                engagementColor = '#E1D687'; // Yellow
            } else {
                engagementColor = '#75BB7D'; // Green
            }

            updateGauge(engagementFill, engagementPercentage, engagementColor);
            engagementText.textContent = Math.round(engagementPercentage) + '%'; // Rounded

            /*** Calculate Return-On-Labor® ***/
            const engagementFactor = (0.46 * (engagementPercentage / 100)) + 0.54;
            const returnOnLabor = engagementFactor * laborCost;
            const returnOnLaborPercentage = Math.round( (returnOnLabor / laborCost) * 100 ); // Rounded

            let returnOnLaborColor = '';

            if (returnOnLaborPercentage <= 50) {
                returnOnLaborColor = '#ED5C5C'; // Red
            } else if (returnOnLaborPercentage <= 84) {
                returnOnLaborColor = '#E1D687'; // Yellow
            } else {
                returnOnLaborColor = '#75BB7D'; // Green
            }

            updateGauge(returnOnLaborFill, returnOnLaborPercentage, returnOnLaborColor);
            returnOnLaborText.textContent = Math.round(returnOnLaborPercentage) + '%'; // Rounded

            /*** Update Financial Metrics ***/
            const lostLaborCost = laborCost - returnOnLabor;
            const formattedLostLaborCost = `-$${Math.round(lostLaborCost).toLocaleString('en-US')}`; // Rounded
            lostLaborCostEl.textContent = formattedLostLaborCost;

            const onePercentChange = Math.round(0.0046 * laborCost); // Rounded
            const formattedOnePercentChange = `$${onePercentChange.toLocaleString('en-US')}`;
            onePercentChangeEl.textContent = formattedOnePercentChange;

            /*** Calculate Projected Turnover Costs ***/
            // Estimate headcount
            const estimatedHeadcount = laborCost / averageSalary;

            // Convert turnover percentage to decimal
            const turnoverDecimal = turnoverPercentage / 100;

            // Projected Turnover Costs
            const projectedTurnoverCosts = estimatedHeadcount * turnoverDecimal * costToReplaceOneEmployee;

            /*** Calculate Total Annualized Losses ***/
            const totalAnnualizedLosses = lostLaborCost + projectedTurnoverCosts;
            const formattedTotalAnnualizedLosses = `-$${Math.round(totalAnnualizedLosses).toLocaleString('en-US')}`; // Rounded
            totalAnnualizedLossesEl.textContent = formattedTotalAnnualizedLosses;
        }

        function resetGauges() {
            // Reset Overall Engagement gauge to 0%
            updateGauge(engagementFill, 0, '#ED5C5C');
            engagementText.textContent = '0%';

            // Reset Return-On-Labor® gauge to 0%
            updateGauge(returnOnLaborFill, 0, '#E1D687');
            returnOnLaborText.textContent = '0%';

            // Reset financial metrics to '--'
            lostLaborCostEl.textContent = '--';
            onePercentChangeEl.textContent = '--';
            totalAnnualizedLossesEl.textContent = '--';
        }

        // Add keyboard support for tooltips
        const infoIcons = document.querySelectorAll('.info-icon');
        infoIcons.forEach(icon => {
            icon.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    const tooltip = this.querySelector('.tooltip');
                    tooltip.style.visibility = 'visible';
                    tooltip.style.opacity = '1';
                }
            });
            
            icon.addEventListener('blur', function() {
                const tooltip = this.querySelector('.tooltip');
                tooltip.style.visibility = 'hidden';
                tooltip.style.opacity = '0';
            });
        });

        // Add this to your existing JavaScript
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        // Add install prompt handling
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button or banner
            showInstallPromotion();
        });

        // Add this to your existing DOMContentLoaded event listener
        function setupTooltips() {
            const infoIcons = document.querySelectorAll('.info-icon');
            let activeTooltip = null;

            function closeActiveTooltip() {
                if (activeTooltip) {
                    activeTooltip.querySelector('.tooltip').style.visibility = 'hidden';
                    activeTooltip.querySelector('.tooltip').style.opacity = '0';
                    activeTooltip = null;
                }
            }

            infoIcons.forEach(icon => {
                icon.addEventListener('touchstart', function(e) {
                    e.preventDefault(); // Prevent default touch behavior
                    e.stopPropagation(); // Stop event from bubbling
                    
                    const tooltip = this.querySelector('.tooltip');
                    
                    if (activeTooltip === this) {
                        closeActiveTooltip();
                        return;
                    }
                    
                    closeActiveTooltip();
                    
                    tooltip.style.visibility = 'visible';
                    tooltip.style.opacity = '1';
                    activeTooltip = this;
                });

                icon.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    // ... rest of click handling
                });
            });

            // Close tooltip when touching anywhere else
            document.addEventListener('touchstart', function(e) {
                if (!e.target.closest('.info-icon')) {
                    closeActiveTooltip();
                }
            });

            // Keep existing click and keyboard handlers
            // ... rest of the setupTooltips function
        }

        setupTooltips();
    });

    function showInstallPromotion() {
        const banner = document.createElement('div');
        banner.className = 'install-banner';
        banner.innerHTML = `
            <div>Install this app on your device for easy access</div>
            <button id="installBtn">Install</button>            
            <button id="closeInstallBtn">✕</button>
        `;
        document.body.appendChild(banner);
        
        document.getElementById('installBtn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                banner.remove();
            }
        });
        
        document.getElementById('closeInstallBtn').addEventListener('click', () => {
            banner.remove();
        });
    }
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
// Add this inside your existing DOMContentLoaded event listener
const resultsModal = document.getElementById('resultsModal');
const resultsForm = document.getElementById('resultsForm');
const downloadPdfBtn = document.getElementById('downloadPdfBtn');
const emailResultsBtn = document.getElementById('emailResultsBtn');
const closeModal = resultsModal.querySelector('.close-modal');

// Function to handle form data submission
async function handleSubmission(action) {
    const form = document.getElementById('resultsForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    try {
        // Get form data with null checks
        const submissionData = {
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            name: document.getElementById('name').value || '',
            company: document.getElementById('company').value || '',
            email: document.getElementById('email').value || '',
            calculatorInputs: {
                laborSpend: document.getElementById('totalLaborCost').value || '0',
                engagement: document.getElementById('employeeEngagement').value || '0',
                turnover: document.getElementById('turnoverPercentage').value || '0'
            },
            results: {
                overallEngagement: document.getElementById('engagementText')?.textContent || '0%',
                returnOnLabor: document.getElementById('returnOnLaborText')?.textContent || '0%',
                onePercentShift: document.getElementById('onePercentChange')?.textContent || '$0',
                lostLabor: document.getElementById('lostLaborCost')?.textContent || '$0',
                totalLosses: document.getElementById('totalLosses')?.textContent || '$0',
                totalAnnualizedLosses: document.getElementById('totalAnnualizedLosses')?.textContent || '$0'
            }
        };

        // Save to Firebase
        await db.collection('submissions').add(submissionData);
        
        // Send to Google Sheets
        await sendToGoogleSheets(submissionData);

        // Perform user's requested action
        if (action === 'download') {
            await generatePDF();
        } else if (action === 'email') {
            const subject = encodeURIComponent('Your Culture MRI® Calculator Results');
            const body = encodeURIComponent(`
                Hello ${submissionData.name},

                Here are your Culture MRI® Calculator results:

                Overall Engagement: ${submissionData.results.overallEngagement}
                Return on Labor: ${submissionData.results.returnOnLabor}
                One Percent Shift Impact: ${submissionData.results.onePercentShift}
                Lost Labor: ${submissionData.results.lostLabor}
                Total Annualized Losses with Turnover: ${submissionData.results.totalAnnualizedLosses}

                Thank you for using the Culture MRI® Calculator!
            `);
            window.location.href = `mailto:${submissionData.email}?subject=${subject}&body=${body}`;
        }

        resultsModal.style.display = 'none';
        resultsForm.reset();

    } catch (error) {
        console.error('Error in handleSubmission:', error);
        alert('Error processing your request: ' + error.message);
    }
}

// Show modal when main button is clicked
document.getElementById('downloadResultsBtn').onclick = () => {
    console.log('Main download button clicked'); // Debug log
    const laborCost = document.getElementById('totalLaborCost').value;
    const engagement = document.getElementById('employeeEngagement').value;
    const turnover = document.getElementById('turnoverPercentage').value;

    if (!laborCost || !engagement || !turnover) {
        alert('Please fill in all calculator fields first.');
        return;
    }

    resultsModal.style.display = 'block';
};

// Handle PDF download button
downloadPdfBtn.onclick = () => handleSubmission('download');

// Handle email button
emailResultsBtn.onclick = () => handleSubmission('email');

// Close modal handlers
closeModal.onclick = () => {
    resultsModal.style.display = 'none';
}

window.onclick = (e) => {
    if (e.target === resultsModal) {
        resultsModal.style.display = 'none';
    }
}
</script>

<script>
// Add this function after your existing JavaScript
async function generatePDF() {
    // Get the data
    const data = {
        laborCost: document.getElementById('totalLaborCost').value,
        engagement: document.getElementById('employeeEngagement').value,
        turnover: document.getElementById('turnoverPercentage').value,
        lostLabor: document.getElementById('lostLaborCost').textContent,
        onePercentChange: document.getElementById('onePercentChange').textContent,
        totalLosses: document.getElementById('totalLosses').textContent,
        totalAnnualizedLosses: document.getElementById('totalAnnualizedLosses').textContent
    };

    // Create PDF directly
    const pdf = new jspdf.jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4'
    });

    // Add content directly to PDF
    pdf.setFont("helvetica", "normal");
    
    // Header
    pdf.setFontSize(24);
    pdf.text("Profitability Loss Report", 105, 20, { align: "center" });
    
    // Date
    pdf.setFontSize(12);
    pdf.setTextColor(107, 125, 141); // #6B7D8D
    pdf.text(new Date().toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    }), 195, 20, { align: "right" });

    // Input Summary
    pdf.setFontSize(16);
    pdf.setTextColor(51, 51, 51); // #333333
    pdf.text("Input Summary", 20, 40);

    pdf.setFontSize(12);
    pdf.setTextColor(107, 125, 141);
    pdf.text([
        `Total Labor Spend: ${data.laborCost}`,
        `Employee Engagement: ${data.engagement}%`,
        `Turnover Rate: ${data.turnover}%`
    ], 20, 55);

    // Results
    pdf.setFontSize(16);
    pdf.setTextColor(51, 51, 51);
    pdf.text("Financial Impact", 20, 90);

    pdf.setFontSize(12);
    pdf.setTextColor(107, 125, 141);
    pdf.text([
        `Lost Labor Cost: ${data.lostLabor}`,
        `1% Engagement Shift Impact: ${data.onePercentChange}`,
        `Total Losses: ${data.totalLosses}`,
        `Total Annualized Losses with Turnover: ${data.totalAnnualizedLosses}`
    ], 20, 105);

    // Footer
    pdf.setFontSize(10);
    pdf.setTextColor(119, 119, 119);
    pdf.text("© 2024 The Culture MRI®. All Rights Reserved.", 105, 280, { align: "center" });

    // Save PDF
    pdf.save(`CMRI-Profit-Report-${new Date().toISOString().split('T')[0]}.pdf`);
}

// Update the click handlers
document.querySelector('.download-pdf').onclick = generatePDF;

</script>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<!-- Firebase Init -->
<script>
    // Initialize Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyD633p4rebsdUD0daRrd0dHIMh_n6hl2Ac",
        authDomain: "cmri-calculator.firebaseapp.com",
        projectId: "cmri-calculator",
        storageBucket: "cmri-calculator.firebasestorage.app",
        messagingSenderId: "740570329582",
        appId: "1:740570329582:web:fb426b5875e64005239eff",
        measurementId: "G-FP80T226QJ"
    };

    // Initialize Firebase and get Firestore reference
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
</script>

</body>
</html>
